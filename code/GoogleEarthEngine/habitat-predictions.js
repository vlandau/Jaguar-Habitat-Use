var SA = ee.FeatureCollection("users/VincentLandau/Jaguar/StudyAreaAlbers20180607"),
    move = ee.FeatureCollection("users/VincentLandau/Jaguar/LocationData/SonoraMovement"),
    USA = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-114.8314528959836, 32.497621237162384],
          [-114.1722732084836, 32.298181414989344],
          [-112.9747634428586, 31.93062352501026],
          [-111.0906081694211, 31.331959115330573],
          [-109.6843581694211, 31.331959115330573],
          [-108.2121902006711, 31.331959115330573],
          [-108.2121902006711, 31.790657574280377],
          [-106.6631179350461, 31.785988384443794],
          [-104.2406325834836, 31.734611737237255],
          [-104.2571120756711, 36.546623724059025],
          [-115.24319729149465, 36.51113306948512],
          [-115.17727932274465, 33.06548500206297]]]),
    all = /* color: #98ff00 */ee.Geometry.Polygon(
        [[[-115.74856838524465, 35.3547350714659],
          [-115.11136135399465, 25.722413007175486],
          [-107.15725979149465, 25.841125596510377],
          [-105.81692776024465, 30.203723267461566],
          [-106.12454494774465, 35.46218689803966]]]),
    pres = ee.FeatureCollection("users/VincentLandau/Jaguar/LocationData/mergedPresencePoints"),
    northI10 = /* color: #1524d6 */ee.Geometry.Polygon(
        [[[-114.08501700900808, 33.67931222914214],
          [-114.06862334750906, 33.67856226982325],
          [-114.06128482364431, 33.67784801677125],
          [-114.05699328922049, 33.67674091281502],
          [-114.05145720981375, 33.67470523285606],
          [-114.04763774417654, 33.672633789747294],
          [-114.0395267441155, 33.66788356802535],
          [-114.03497771762625, 33.66566908929752],
          [-114.03218822025076, 33.66474041996157],
          [-114.02742461704031, 33.663525991087674],
          [-114.01781157993094, 33.662204387245616],
          [-113.98751334689871, 33.65866810415982],
          [-113.96918849490896, 33.65648910989239],
          [-113.91674594424978, 33.650166142068166],
          [-113.86829452060476, 33.64430715841323],
          [-113.82010058902517, 33.63841204683611],
          [-113.7680013611199, 33.63080139691977],
          [-113.72757510684744, 33.62479815639078],
          [-113.68002490543142, 33.617758109326005],
          [-113.63307551883474, 33.61071748710677],
          [-113.58694152377859, 33.60385500749644],
          [-113.52728919528738, 33.59495441573373],
          [-113.44235972903982, 33.58229898117463],
          [-113.35369662784353, 33.56878350179165],
          [-113.22623805545584, 33.54947200352853],
          [-113.1750829651238, 33.54160311829811],
          [-113.14967708133474, 33.536166015426154],
          [-113.1047876312615, 33.52622095571927],
          [-113.04625110172049, 33.51634631170027],
          [-112.98076228641287, 33.505253881930244],
          [-112.9535539581658, 33.50060179466565],
          [-112.93896274112478, 33.497738847458024],
          [-112.88428859256521, 33.48549868063406],
          [-112.82729701541678, 33.47275561662832],
          [-112.80103282474295, 33.46674138491095],
          [-112.73923472903982, 33.45270655459766],
          [-112.68464641116873, 33.44067489187616],
          [-112.66061381839529, 33.43537470148694],
          [-112.65572146915213, 33.43430029910614],
          [-112.6462800934197, 33.4311486420521],
          [-112.63220386050955, 33.4286415603929],
          [-112.62404994510428, 33.42706564342757],
          [-112.61787013553396, 33.42670747649069],
          [-112.61435107730642, 33.42685074344277],
          [-112.60808543704763, 33.42778197286775],
          [-112.59049014590994, 33.43329751154934],
          [-112.51109675906912, 33.45907979486637],
          [-112.50268535159842, 33.46158599697365],
          [-112.49676303409353, 33.46237364552978],
          [-112.46800975345388, 33.46251685358931],
          [-112.46380404971853, 33.462158832996984],
          [-112.45796756290213, 33.46137118248909],
          [-112.4452646210076, 33.46122797253698],
          [-112.43453578494803, 33.46144278737645],
          [-112.41676883243338, 33.46165760168361],
          [-112.4082715942742, 33.461084762348285],
          [-112.38106326602713, 33.46101315716522],
          [-112.37462596439138, 33.459939072322065],
          [-112.3669012024285, 33.4577192548111],
          [-112.35093669437185, 33.457432822605305],
          [-112.31497363590017, 33.4577192548111],
          [-112.2958333923699, 33.46101315716522],
          [-112.26699428104178, 33.4615859969737],
          [-112.24819736026541, 33.46201562434602],
          [-112.20579700015799, 33.46244524958915],
          [-112.17927531741873, 33.46287487270303],
          [-112.1639974548699, 33.46251685358931],
          [-112.15120868228689, 33.4614427873765],
          [-112.143483920324, 33.46158599697375],
          [-112.13833407901541, 33.46201562434607],
          [-112.13438586734549, 33.46273166523503],
          [-112.13086680911795, 33.46237364552985],
          [-112.12640361331717, 33.46165760168366],
          [-112.110524935949, 33.4614427873765],
          [-112.09739284061209, 33.461371182489145],
          [-112.09241466068045, 33.46165760168366],
          [-112.08623485111013, 33.46101315716527],
          [-112.08228663944021, 33.4605119192278],
          [-112.077565951574, 33.46165760168366],
          [-112.07378940128103, 33.46158599697375],
          [-112.06752376102224, 33.46223043723377],
          [-112.06348971866385, 33.46187241545854],
          [-112.05722407840506, 33.46180081092605],
          [-112.03902797244803, 33.46151439220469],
          [-112.03727678610403, 33.45950319462058],
          [-112.0373626167925, 33.429065108735685],
          [-112.0359034950884, 33.42777573054742],
          [-112.03015283896048, 33.42662960052321],
          [-112.0245738442095, 33.42469547179228],
          [-112.02079729391653, 33.42204492909908],
          [-112.01865152670462, 33.419609223928035],
          [-112.01564745260794, 33.415883895621874],
          [-112.01161341024954, 33.41244498918203],
          [-112.00620607687551, 33.41079713159009],
          [-111.99496225668508, 33.41072548489864],
          [-111.97865442587454, 33.41072548489864],
          [-111.97359041525442, 33.409579129797905],
          [-111.9696422035845, 33.40656987567755],
          [-111.9670672829302, 33.40277233480084],
          [-111.96801142050344, 33.38851216198446],
          [-111.9681830818804, 33.36937549098669],
          [-111.96844057394583, 33.36414263443723],
          [-111.97153047873098, 33.352098700547764],
          [-111.97195963217337, 33.34707990287911],
          [-111.9722171242388, 33.34055503339475],
          [-111.97230295492727, 33.32298564726027],
          [-111.9722171242388, 33.29737819974006],
          [-111.97178797079641, 33.29041913467457],
          [-111.9707580025347, 33.28597078169025],
          [-111.96775392843801, 33.28066116033195],
          [-111.96337656332571, 33.27513594115223],
          [-111.95307688070852, 33.26193140385189],
          [-111.94423631979544, 33.249945122731276],
          [-111.93942980124075, 33.244059041475715],
          [-111.92106203390676, 33.22036714636759],
          [-111.90938906027395, 33.20478443289744],
          [-111.89282373739798, 33.18395527736573],
          [-111.87067941977102, 33.15485799561984],
          [-111.85548738791067, 33.13559818871126],
          [-111.83711962057669, 33.11173316326091],
          [-111.79625687537441, 33.05825112140448],
          [-111.76415619788418, 33.0166622332864],
          [-111.7432135098959, 32.99031725180415],
          [-111.7160910123373, 32.956906842594954],
          [-111.70373139319668, 32.941925660417134],
          [-111.69634995398769, 32.93212889945517],
          [-111.69051346717129, 32.92492470645299],
          [-111.68742356238613, 32.9184404311921],
          [-111.68673691687832, 32.90719989528254],
          [-111.68708023963222, 32.89408413292518],
          [-111.68708023963222, 32.86481889570797],
          [-111.68708023963222, 32.84881263604898],
          [-111.6860502713705, 32.83684210451666],
          [-111.68502030310879, 32.824725706179954],
          [-111.68416199622402, 32.819965240258064],
          [-111.68124375281582, 32.815781589908575],
          [-111.67437729773769, 32.811020644707526],
          [-111.66167435584316, 32.80337374437867],
          [-111.62614045081386, 32.78115071648797],
          [-111.56331238684902, 32.74231925188144],
          [-111.55301270423183, 32.735821628676106],
          [-111.5428846829916, 32.73235603592195],
          [-111.53138337073574, 32.72961234609581],
          [-111.52142701087246, 32.726146511927],
          [-111.51404557166347, 32.72181402974897],
          [-111.50099930701504, 32.71415946345891],
          [-111.48692307410488, 32.7082375558531],
          [-111.46117386756191, 32.6917696980771],
          [-111.42958817420254, 32.67211985842452],
          [-111.41225037513027, 32.66084814682448],
          [-111.39954743323574, 32.65116490053231],
          [-111.39096436438808, 32.64610607124934],
          [-111.38049302039394, 32.63960144167373],
          [-111.37087998328457, 32.63107243292608],
          [-111.33912262854824, 32.592031004294796],
          [-111.32092652259121, 32.569899974411136],
          [-111.30513367591152, 32.551380929686715],
          [-111.27131638465175, 32.510857197421046],
          [-111.26462159095058, 32.49797261144969],
          [-111.26221833167324, 32.49435301361074],
          [-111.25569519934902, 32.48986451001371],
          [-111.19183716712246, 32.44453256054933],
          [-111.1308973783041, 32.40077212294436],
          [-111.12076935706386, 32.393235071124316],
          [-111.1147612088705, 32.38497258004741],
          [-111.10514817176113, 32.37395474962438],
          [-111.08008561072597, 32.34944975944993],
          [-111.05673966346035, 32.32812936818366],
          [-111.04952988562832, 32.32029612636774],
          [-111.03734192786465, 32.30201592716162],
          [-111.02635559973965, 32.290407537222464],
          [-111.00987610755215, 32.270089278213774],
          [-111.00335297522793, 32.26065425382027],
          [-110.99957642493496, 32.258331635841884],
          [-110.98618683753261, 32.241490878414666],
          [-110.98326859412441, 32.23452137565627],
          [-110.98017868933925, 32.22188778927611],
          [-110.9796637052084, 32.207364256496994],
          [-110.97914872107754, 32.19647008478874],
          [-110.97605881629238, 32.19080459998114],
          [-110.96850571570644, 32.18659157495637],
          [-110.95872101722011, 32.18412177997434],
          [-110.95339951453457, 32.18223306801309],
          [-110.93846497473965, 32.17351542817211],
          [-110.91477570472011, 32.16043740375402],
          [-110.89966950354824, 32.15200834885193],
          [-110.89572129187832, 32.14822955395108],
          [-110.89297470984707, 32.144159907348275],
          [-110.89108643470058, 32.14067149425501],
          [-110.88868317542324, 32.13500253836447],
          [-110.88542160926113, 32.13064156329758],
          [-110.87941346106777, 32.12758875670675],
          [-110.82431015906582, 32.092983144272864],
          [-110.79650101599941, 32.07582087703773],
          [-110.72749314246425, 32.031300325853316],
          [-110.70431885657558, 32.01630977835626],
          [-110.68371949134121, 32.00262694389944],
          [-110.67650971350918, 32.00044332390107],
          [-110.65659699378261, 31.996367094098776],
          [-110.62998948035488, 31.997822911257654],
          [-110.60372528968105, 31.991417142889013],
          [-110.5899923795248, 31.987922898839123],
          [-110.53334412513027, 31.981516439056882],
          [-110.5127447598959, 31.977439368106783],
          [-110.50038514075527, 31.972779636652565],
          [-110.47051606116543, 31.968119668633012],
          [-110.45678315100918, 31.96433327044033],
          [-110.45163330970058, 31.96200310163239],
          [-110.34863648352871, 31.962585649377935],
          [-110.33387360511074, 31.96695463966696],
          [-110.32014069495449, 31.97452706367143],
          [-110.30778107581386, 31.978604264004787],
          [-110.29507813391933, 31.97831304141654],
          [-110.28821167884121, 31.97510953195153],
          [-110.28374848304043, 31.971323422057885],
          [-110.27619538245449, 31.967245898294458],
          [-110.2710455411459, 31.965789595917084],
          [-110.26143250403652, 31.965207068498255],
          [-110.25216278968105, 31.965498332669664],
          [-110.24151978430996, 31.968702177571977],
          [-110.23053345618496, 31.976274457422253],
          [-110.22435364661465, 31.97831304141654],
          [-110.19002137122402, 31.987922898839123],
          [-110.12204346595058, 32.01354426376046],
          [-110.1117437833334, 32.018201924466034],
          [-110.10316071448574, 32.03304663785528],
          [-110.08599457679043, 32.049052946004984],
          [-110.06808009928625, 32.06738400510856],
          [-110.05743709391515, 32.079020866190284],
          [-110.04267421549719, 32.08542050844056],
          [-110.00422206705969, 32.13631079022981],
          [-109.99186244791906, 32.150554984735365],
          [-109.97332301920812, 32.161309330456014],
          [-109.94070735758703, 32.18252364163478],
          [-109.88131252116125, 32.21738574220681],
          [-109.84526363200109, 32.262976812370525],
          [-109.83084407633703, 32.2798135843467],
          [-109.81985774821203, 32.288811267354866],
          [-109.80440822428625, 32.30100025239245],
          [-109.78930202311437, 32.313187598323054],
          [-109.77694240397375, 32.32363258998878],
          [-109.75943294352453, 32.33697721507425],
          [-109.74638667887609, 32.34625927222013],
          [-109.73402705973547, 32.35031987280394],
          [-109.69042506998937, 32.35786050458687],
          [-109.66192928141515, 32.36047057679848],
          [-109.64647975748937, 32.36221058308466],
          [-109.61832729166906, 32.36163058470979],
          [-109.61146083659094, 32.35670044831074],
          [-109.6042510587589, 32.34770950763762],
          [-109.59017482584875, 32.34480901355528],
          [-109.54485622233312, 32.33668713544677],
          [-109.51876369303625, 32.33175563953183],
          [-109.50674739664953, 32.32566342070009],
          [-109.49713435954015, 32.319280656519794],
          [-109.48649135416906, 32.31666939605357],
          [-109.4394561368839, 32.31637925135451],
          [-109.25543514079015, 32.27574982199826],
          [-109.2358657438175, 32.26587992698197],
          [-109.22556606120031, 32.26268649580193],
          [-109.208399923505, 32.258041304416885],
          [-109.19398036784094, 32.25629929636312],
          [-109.18196407145422, 32.25775097206259],
          [-109.05424800700109, 32.22900347347829],
          [-109.02952876871984, 32.222033012889725],
          [-108.99279323405187, 32.22755133827109],
          [-108.97356715983312, 32.226970477691715],
          [-108.92893520182531, 32.25194412999055],
          [-108.79709926432531, 32.32653376277564],
          [-108.75075069254797, 32.3535102168227],
          [-108.74560085123937, 32.35438029111613],
          [-108.73804775065344, 32.35235010474475],
          [-108.72637477702062, 32.347419462413946],
          [-108.71126857584875, 32.341328297913705],
          [-108.69410243815344, 32.34103823223299],
          [-108.68311611002844, 32.3401680296119],
          [-108.66938319987219, 32.335816890985875],
          [-108.63573756998937, 32.32943484260331],
          [-108.48467555827062, 32.23916777023609],
          [-108.42768398112219, 32.20489502524732],
          [-108.38648525065344, 32.17932728079672],
          [-108.36519923991125, 32.1804896068115],
          [-108.31438747233312, 32.19065932650292],
          [-108.19903102702062, 32.212447756828595],
          [-108.16195216959875, 32.21883803981354],
          [-108.12899318522375, 32.22319479344202],
          [-108.09637752360265, 32.22755133827109],
          [-108.05346217936437, 32.23306932862102],
          [-108.0163833219425, 32.23800619386846],
          [-107.98445430582922, 32.24178126276053],
          [-107.90274349039953, 32.2528151799775],
          [-107.79185024088781, 32.266170233335565],
          [-107.71082607096594, 32.2763303706226],
          [-107.69434657877844, 32.28126488392176],
          [-107.66447749918859, 32.28358691493911],
          [-107.63117519205969, 32.287360088542215],
          [-107.58722987955969, 32.282135652520104],
          [-107.56560054606359, 32.28068436687839],
          [-107.55221095866125, 32.27574982199826],
          [-107.52920833414953, 32.26820235180799],
          [-107.4893828946964, 32.25717030456835],
          [-107.46603694743078, 32.24962128917421],
          [-107.24211049967857, 32.60764940713741],
          [-106.69748725045645, 33.40024322615675],
          [-106.56565131295645, 34.23086002998685],
          [-107.23581732858145, 34.611490940822655],
          [-109.88352240670645, 35.22406364776114],
          [-111.77317084420645, 35.34065163435516],
          [-114.56369818795645, 35.26892504560111],
          [-114.68454779733145, 33.97614538461353],
          [-114.30002631295645, 33.72980278095352]]]),
    geometry = /* color: #d63000 */ee.Geometry.Point([-110.3955865857809, 31.543199690136472]);


var ALOS = ee.Image('JAXA/ALOS/AW3D30_V1_1').select('MED')
var n = ee.Number(10000)
var samples = ee.FeatureCollection("users/VincentLandau/Jaguar/MCMCsamples_int_rug_rug2_rip").limit(n);

print(ee.Feature(samples.first()).toArray(['intercept','chiliSD3240','chili3240Sq','riparianDist']))


var covars = ee.Image("users/VincentLandau/Jaguar/RSPFcovariates").select(["constant","chiliSD3240", "chiliSD3240_1", "riparianDist"])
print(covars.bandNames())

//Map.addLayer(covars)
var RSPF = function(f){
  var array = f.toArray(['intercept','chiliSD3240','chili3240Sq','riparianDist']);
  var params = ee.Image(array).arrayFlatten([['intercept','chiliSD3240','chili3240Sq','riparianDist']]);
  var expProb = ee.Image(covars.multiply(params).toArray().arrayReduce({reducer:ee.Reducer.sum(),axes:[0]})).arrayFlatten([['array']]).exp();
  var prob = expProb.divide(expProb.add(1.0));
  return ee.Image(expProb);
};

var probs = ee.ImageCollection(samples.map(RSPF)).limit(n);
var sd = probs.reduce({reducer:ee.Reducer.stdDev(),parallelScale:8});
var mean = probs.reduce({reducer:ee.Reducer.mean(),parallelScale:8});
Map.addLayer(mean.clip(SA.geometry()),{min:-12,max:-1,palette:['d7191c','fdae61','ffdc8f','ffffbf','abd9e9','2c7bb6']},"HS Mean")
Map.addLayer(sd.clip(SA.geometry()),{min:0.1,max:3,palette:['2c7bb6','abd9e9','ffffbf','ffdc8f','fdae61','d7191c']},"HS Standard Deviation")


/// Get estimates of total habitat area incorporating uncertainty
var predictArea = function(i){
  //// Calculate RSPF image
  var array = ee.Feature(samples.toList(n).get(i)).toArray(['intercept','chiliSD3240','chili3240Sq','riparianDist']);
  var params = ee.Image(array).arrayFlatten([['intercept','chiliSD3240','chili3240Sq','riparianDist']]);
  var expProb = ee.Image(covars.multiply(params).toArray().arrayReduce({reducer:ee.Reducer.sum(),axes:[0]})).arrayFlatten([['array']]).exp();
  var image = expProb.divide(expProb.add(1.0)).clip(SA);
  
  ///// Probability sum predictions
  var probSumI10 = ee.Number(image.multiply(ee.Image.pixelArea()).reduceRegion({geometry:northI10,
                                                                     reducer:ee.Reducer.sum(),
                                                                     crs:"EPSG:4326",
                                                                     crsTransform:[0.0002777777777777778,0,-180,0,-0.0002777777777777778,83],
                                                                     maxPixels:1e13
  }).get('array')).divide(1000000);
  var probSumAll = ee.Number(image.multiply(ee.Image.pixelArea()).reduceRegion({geometry:all,
                                                                     reducer:ee.Reducer.sum(),
                                                                     crs:"EPSG:4326",
                                                                     crsTransform:[0.0002777777777777778,0,-180,0,-0.0002777777777777778,83],
                                                                     maxPixels:1e13
  }).get('array')).divide(1000000);
  var probSumUS = ee.Number(image.multiply(ee.Image.pixelArea()).reduceRegion({geometry:USA,
                                                                     reducer:ee.Reducer.sum(),
                                                                     crs:"EPSG:4326",
                                                                     crsTransform:[0.0002777777777777778,0,-180,0,-0.0002777777777777778,83],
                                                                     maxPixels:1e13
  }).get('array')).divide(1000000);
  
  var values = ee.Dictionary.fromLists(['probSumUS','probSumI10','probSumAll'],
                                       [probSumUS,probSumI10,probSumAll]
);
  return ee.Feature(geometry,values);
};
var base = ee.String("users/VincentLandau/Jaguar/RSPFfixedoutput2/correctHabitatSummaries/");

for (var i = 0; i < 20; i+= 1) { // must do in batches because GEE fails with large tasks
  var lower = ee.Number(0).add(ee.Number(500).multiply(ee.Number(i)));
  var upper = lower.add(499);
  var preds = ee.FeatureCollection(ee.List.sequence(lower.int(),upper.int(),1).map(predictArea));
  var assetId = base.cat(ee.String(lower)).cat(ee.String("_").cat(ee.String(upper)));
  Export.table.toAsset({collection:preds,
                      description:ee.String(lower).cat(ee.String("_").cat(ee.String(upper))).getInfo(),
                      assetId:assetId.getInfo()
});
}

Export.image.toAsset({image:mean,
                      region:SA,
                      description:"exportMean",
                      crs:"EPSG:4326",
                      crsTransform:[0.0002777777777777778,0,-180,0,-0.0002777777777777778,83],
                      assetId:"users/VincentLandau/Jaguar/RSPFfixedoutput2/RSPFmeanProb_10000samples",
                      maxPixels:1e13
});
Export.image.toAsset({image:sd,
                      region:SA,
                      description:"exportSd",
                      crs:"EPSG:4326",
                      crsTransform:[0.0002777777777777778,0,-180,0,-0.0002777777777777778,83],
                      assetId:"users/VincentLandau/Jaguar/RSPFfixedoutput2/RSPFstDev_10000samples",
                      maxPixels:1e13
});

